name: build engine for pi4

on:
  push:
    tags:
      - '**'
  pull_request:
    branches: [ ci ]
  repository_dispatch:
  workflow_dispatch:
  workflow_call:
  
jobs:
  populate-engine-src-cache:
    name: 'Prepopulate engine source cache'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      
      - run: |
          echo github.ref: ${{ github.ref }}

      - name: Read stable engine version
        id: engine-version-stable

        # Read the engine.version.stable file and trim away anything that's not a hex digit
        # (So we don't include whitespace in the output variable, if that's possible)
        run: echo ::set-output name=hash::$(cat engine.version.stable | tr -dc [:xdigit:])
      
      - name: Log stable engine version
        run: |
          echo stable engine version: "${{ steps.engine-version-stable.outputs.hash }}"
      
      - name: Create engine cache stamp dir
        shell: bash
        run: |
          mkdir -p engine-cache-stamp

      - uses: actions/cache@v3
        id: stamp-cache
        with:
          path: engine-cache-stamp
          key: engine-cache-stamp-${{ steps.engine-version-stable.outputs.hash }}

      - name: Log cache hit
        shell: bash
        run: |
          echo cache hit? ${{ steps.stamp-cache.outputs.cache-hit }}

      - uses: actions/cache@v3
        id: cache
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        with:
          path: engine
          key: engine-${{ steps.engine-version-stable.outputs.hash }}

      - name: Setup environment variables
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          # echo DEPOT_TOOLS_UPDATE=0 >> $GITHUB_ENV
          echo GCLIENT_PY3=1 >> $GITHUB_ENV
          echo $PATH
          
      - name: Clone depot tools
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $GITHUB_WORKSPACE/depot_tools
          echo $GITHUB_WORKSPACE/depot_tools >> $GITHUB_PATH
      
      - name: Setup environment variables
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          # echo DEPOT_TOOLS_UPDATE=0 >> $GITHUB_ENV
          echo GCLIENT_PY3=1 >> $GITHUB_ENV
          echo $PATH
          echo is-host: ${{ inputs.is-host }}
          
      - name: Setup gclient
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          gclient --version
          echo DEPOT_TOOLS_UPDATE=0 >> $GITHUB_ENV
          
      - name: Bootstrap engine environment
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        shell: bash
        run: |
          mkdir -p engine
          echo 'solutions = [{ "managed": False, "name": "src/flutter", "url": "https://github.com/flutter/engine.git", "deps_file": "DEPS", "custom_vars":{ "download_linux_deps": True, "download_android_deps": False}, },]' > engine/.gclient
      
      - name: Install engine sources
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        shell: bash
        working-directory: engine
        run: |
          gclient sync --revision src/flutter@${{ steps.engine-version-stable.outputs.hash }} -R -D
      
      - name: Install linux arm sysroot
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        shell: bash
        working-directory: engine
        run: |
          ./src/build/linux/sysroot_scripts/install-sysroot.py --arch=arm

      - name: Prune git history
        if: ${{ steps.stamp-cache.outputs.cache-hit != 'true' }}
        shell: bash
        working-directory: engine
        run: |
          for FILE in $(find . -type d -name .git)
          do
            pushd "$FILE/.."
            git rev-parse HEAD > .git/shallow
            git tag -d $(git tag -l) || true
            for ref in $(git for-each-ref --format="%(refname)")
            do
              git update-ref -d "$ref"
            done
            git remote remove origin
            git reflog expire --expire=all --all
            git gc --prune=all
            popd
          done
      
  pi4-debug:
    name: 'Build and deploy flutter engine for Raspberry Pi 4 (32-bit, debug mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache
       
    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: Test output
        run: echo ${{ steps.engine-version-stable.outputs.hash }}
      
      - name: build engine
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: debug
          os: linux
          cpu: arm
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
          additional-raw-gn-args: 'arm_tune = "cortex-a72"'
      
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-pi4-debug
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
    
  pi4-profile:
    name: 'Build and deploy flutter engine for Raspberry Pi 4 (32-bit, profile mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache

    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: build engine
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: profile
          os: linux
          cpu: arm
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
          additional-raw-gn-args: 'arm_tune = "cortex-a72"'
          
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-pi4-profile
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
            ${{ github.workspace }}/engine/src/out/build/clang_x64/gen_snapshot
  
  pi4-release:
    name: 'Build and deploy flutter engine for Raspberry Pi 4 (32-bit, release mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache
    
    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: build engine (armv7 hard-float release)
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: release
          os: linux
          cpu: arm
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
          additional-raw-gn-args: 'arm_tune = "cortex-a72"'
          
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-pi4-release
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
            ${{ github.workspace }}/engine/src/out/build/clang_x64/gen_snapshot
  
  armv7-generic-debug:
    name: 'Build and deploy flutter engine for generic ARMv7 (32-bit, debug mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache
       
    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: Test output
        run: echo ${{ steps.engine-version-stable.outputs.hash }}
      
      - name: build engine
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: debug
          os: linux
          cpu: arm
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
      
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv7-generic-debug
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
  
  armv7-generic-profile:
    name: 'Build and deploy flutter engine for generic ARMv7 (32-bit, profile mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache

    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: build engine
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: profile
          os: linux
          cpu: arm
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
          
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv7-generic-profile
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
            ${{ github.workspace }}/engine/src/out/build/clang_x64/gen_snapshot
  
  armv7-generic-release:
    name: 'Build and deploy flutter engine for generic ARMv7 (32-bit, release mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache
    
    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: build engine (armv7 hard-float release)
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: release
          os: linux
          cpu: arm
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
          
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv7-generic-release
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
            ${{ github.workspace }}/engine/src/out/build/clang_x64/gen_snapshot
  
  armv8-generic-debug:
    name: 'Build and deploy flutter engine for generic ARMv8 (64-bit, debug mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache
       
    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: Test output
        run: echo ${{ steps.engine-version-stable.outputs.hash }}
      
      - name: build engine
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: debug
          os: linux
          cpu: arm64
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
      
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv8-generic-debug
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
  
  armv8-generic-profile:
    name: 'Build and deploy flutter engine for generic ARMv8 (64-bit, profile mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache

    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: build engine
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: profile
          os: linux
          cpu: arm64
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
          
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv8-generic-profile
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
            ${{ github.workspace }}/engine/src/out/build/clang_x64/gen_snapshot
  
  armv8-generic-release:
    name: 'Build and deploy flutter engine for generic ARMv8 (64-bit, release mode).'
    runs-on: ubuntu-latest
    needs: populate-engine-src-cache
    
    steps:
      - uses: actions/checkout@v1
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - name: build engine (armv8 release)
        uses: ./.github/actions/build-engine
        with:
          ref: "${{ steps.engine-version-stable.outputs.hash  }}"
          is-host: false
          runtime-mode: release
          os: linux
          cpu: arm64
          additional-gn-args: '--embedder-for-target --disable-desktop-embeddings --no-build-glfw-shell --no-build-embedder-examples --no-goma'
          
      - name: upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv8-generic-release
          path: |
            ${{ github.workspace }}/engine/src/out/build/compile_commands.json
            ${{ github.workspace }}/engine/src/out/build/libflutter_engine.so
            ${{ github.workspace }}/engine/src/out/build/icudtl.dat
            ${{ github.workspace }}/engine/src/out/build/flutter_embedder.h
            ${{ github.workspace }}/engine/src/out/build/clang_x64/gen_snapshot
  
  release:
    name: 'Publish release'
    runs-on: ubuntu-latest
    needs: 
      - pi4-debug
      - pi4-profile
      - pi4-release
      - armv7-generic-debug
      - armv7-generic-profile
      - armv7-generic-release
      - armv8-generic-debug
      - armv8-generic-profile
      - armv8-generic-release
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v2
      
      - name: Read stable engine version
        id: engine-version-stable
        run: echo ::set-output name=hash::$(cat engine.version.stable)
        
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-pi4-debug
          path: pi4-debug
        
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-pi4-profile
          path: pi4-profile
        
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-pi4-release
          path: pi4-release
          
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv7-generic-debug
          path: armv7-generic-debug
        
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv7-generic-profile
          path: armv7-generic-profile
        
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv7-generic-release
          path: armv7-generic-release
      
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv8-generic-debug
          path: armv8-generic-debug
        
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv8-generic-profile
          path: armv8-generic-profile
        
      - uses: actions/download-artifact@v3
        with:
          name: ${{ steps.engine-version-stable.outputs.hash }}-armv8-generic-release
          path: armv8-generic-release
          
      - name: Package Pi4 artifacts
        run: |
          mkdir -p pi4
          cd pi4
          cp ../engine.version.stable ./engine.version
          cp ../pi4-debug/libflutter_engine.so ./libflutter_engine.so.debug
          cp ../pi4-profile/libflutter_engine.so ./libflutter_engine.so.profile
          cp ../pi4-release/libflutter_engine.so ./libflutter_engine.so.release
          cp ../pi4-debug/flutter_embedder.h ./flutter_embedder.h
          cp ../pi4-debug/icudtl.dat ./icudtl.dat
          cp ../pi4-profile/clang_x64/gen_snapshot ./gen_snapshot_linux_x64_profile
          cp ../pi4-release/clang_x64/gen_snapshot ./gen_snapshot_linux_x64_release
          XZ_DEFAULTS="-T 0" tar -cJvf ../pi4.tar.xz *
      
      - name: Package generic ARMv7 artifacts
        run: |
          mkdir -p armv7-generic
          cd armv7-generic
          cp ../engine.version.stable ./engine.version
          cp ../armv7-generic-debug/libflutter_engine.so ./libflutter_engine.so.debug
          cp ../armv7-generic-profile/libflutter_engine.so ./libflutter_engine.so.profile
          cp ../armv7-generic-release/libflutter_engine.so ./libflutter_engine.so.release
          cp ../armv7-generic-debug/flutter_embedder.h ./flutter_embedder.h
          cp ../armv7-generic-debug/icudtl.dat ./icudtl.dat
          cp ../armv7-generic-profile/clang_x64/gen_snapshot ./gen_snapshot_linux_x64_profile
          cp ../armv7-generic-release/clang_x64/gen_snapshot ./gen_snapshot_linux_x64_release
          XZ_DEFAULTS="-T 0" tar -cJvf ../armv7-generic.tar.xz *
      
      - name: Package generic ARMv8 artifacts
        run: |
          mkdir -p armv8-generic
          cd armv8-generic
          cp ../engine.version.stable ./engine.version
          cp ../armv8-generic-debug/libflutter_engine.so ./libflutter_engine.so.debug
          cp ../armv8-generic-profile/libflutter_engine.so ./libflutter_engine.so.profile
          cp ../armv8-generic-release/libflutter_engine.so ./libflutter_engine.so.release
          cp ../armv8-generic-debug/flutter_embedder.h ./flutter_embedder.h
          cp ../armv8-generic-debug/icudtl.dat ./icudtl.dat
          cp ../armv8-generic-profile/clang_x64/gen_snapshot ./gen_snapshot_linux_x64_profile
          cp ../armv8-generic-release/clang_x64/gen_snapshot ./gen_snapshot_linux_x64_release
          XZ_DEFAULTS="-T 0" tar -cJvf ../armv8-generic.tar.xz *
      
      - uses: softprops/action-gh-release@v0.1.14
        with:
          files: |
            pi4.tar.xz
            armv7-generic.tar.xz
            armv8-generic.tar.xz
  
    
